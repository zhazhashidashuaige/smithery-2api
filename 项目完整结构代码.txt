é¡¹ç›® 'smithery-2api' çš„ç»“æ„æ ‘:
ğŸ“‚ smithery-2api/
    ğŸ“„ .env
    ğŸ“„ .env.example
    ğŸ“„ Dockerfile
    ğŸ“„ docker-compose.yml
    ğŸ“„ main.py
    ğŸ“„ nginx.conf
    ğŸ“„ requirements.txt
    ğŸ“‚ app/
        ğŸ“‚ core/
            ğŸ“„ __init__.py
            ğŸ“„ config.py
        ğŸ“‚ providers/
            ğŸ“„ __init__.py
            ğŸ“„ base_provider.py
            ğŸ“„ smithery_provider.py
        ğŸ“‚ services/
            ğŸ“„ session_manager.py
            ğŸ“„ tool_caller.py
        ğŸ“‚ utils/
            ğŸ“„ sse_utils.py
================================================================================

--- æ–‡ä»¶è·¯å¾„: .env ---

# [è‡ªåŠ¨å¡«å……] smithery-2api ç”Ÿäº§ç¯å¢ƒé…ç½®
# è¯¥æ–‡ä»¶ç”± Genesis Protocol Â· Î© (Omega) ç‰ˆè‡ªåŠ¨ç”Ÿæˆå’Œä¿®æ­£

# --- å®‰å…¨é…ç½® ---
# ç”¨äºä¿æŠ¤æ‚¨çš„ API æœåŠ¡çš„è®¿é—®å¯†é’¥ï¼Œè¯·æŒ‰éœ€ä¿®æ”¹ä¸ºæ‚¨è‡ªå·±çš„å¤æ‚å¯†é’¥ã€‚
API_MASTER_KEY=1

# --- ç«¯å£é…ç½® ---
# Nginx å¯¹å¤–æš´éœ²çš„ç«¯å£
NGINX_PORT=8088

# --- Smithery.ai å‡­è¯ (æ”¯æŒå¤šè´¦å·) ---
# æ ¼å¼å·²æ ¹æ®æœ€ç»ˆæ–¹æ¡ˆè‡ªåŠ¨è½¬æ¢ã€‚è¯·å‹¿æ‰‹åŠ¨ä¿®æ”¹æ­¤ JSON ç»“æ„ã€‚
# æ‚¨å¯ä»¥æ·»åŠ  SMITHERY_COOKIE_2, SMITHERY_COOKIE_3 ç­‰æ¥å¯ç”¨è½®è¯¢
SMITHERY_COOKIE_1='{"access_token":"eyJhbGciOiJIUzI1NiIsImtpZCI6Ikk4N0N0U1U2UHFrWlVVV0QiLCJ0eXAiOiJKV1QifQ.eyJpc3MiOiJodHRwczovL3NwamF3YmZwd2V6amZtaWNvcHNsLnN1cGFiYXNlLmNvL2F1dGgvdjEiLCJzdWIiOiI1OTA1ZjZiNC1kNzRmLTQ2YjQtOWI0Zi05ZGJiY2NiMjliZWUiLCJhdWQiOiJhdXRoZW50aWNhdGVkIiwiZXhwIjoxNzYwNzkxMjY1LCJpYXQiOjE3NjA3ODc2NjUsImVtYWlsIjoiMjg2NDQ2MDQ1OUBxcS5jb20iLCJwaG9uZSI6IiIsImFwcF9tZXRhZGF0YSI6eyJwcm92aWRlciI6ImdpdGh1YiIsInByb3ZpZGVycyI6WyJnaXRodWIiXX0sInVzZXJfbWV0YWRhdGEiOnsiYXZhdGFyX3VybCI6Imh0dHBzOi8vYXZhdGFycy5naXRodWJ1c2VyY29udGVudC5jb20vdS8xMjg4ODAyMDY_dj00IiwiZW1haWwiOiIyODY0NDYwNDU5QHFxLmNvbSIsImVtYWlsX3ZlcmlmaWVkIjp0cnVlLCJmdWxsX25hbWUiOiJDaGluZXNlLXRpbmdmZW5nIiwiaXNzIjoiaHR0cHM6Ly9hcGkuZ2l0aHViLmNvbSIsIm5hbWUiOiJDaGluZXNlLXRpbmdmZW5nIiwicGhvbmVfdmVyaWZpZWQiOmZhbHNlLCJwcmVmZXJyZWRfdXNlcm5hbWUiOiJsekE2IiwicHJvdmlkZXJfaWQiOiIxMjg4ODAyMDYiLCJzdWIiOiIxMjg4ODAyMDYiLCJ1c2VyX25hbWUiOiJsekE2In0sInJvbGUiOiJhdXRoZW50aWNhdGVkIiwiYWFsIjoiYWFsMSIsImFtciI6W3sibWV0aG9kIjoib2F1dGgiLCJ0aW1lc3RhbXAiOjE3NTkxNjA1NDF9XSwic2Vzc2lvbl9pZCI6IjQxM2E0NTJjLTFjYjgtNDY5OC04YjYxLTQxYjQ3YjU5YjE4NyIsImlzX2Fub255bW91cyI6ZmFsc2V9.L4EcDMbtxobs_PpoPjpIfqvLxoIDyo_fFiLD4PyMwDo","token_type":"bearer","expires_in":3600,"expires_at":1760791265,"refresh_token":"4jxavtzs4tbw","user":{"id":"5905f6b4-d74f-46b4-9b4f-9dbbccb29bee","aud":"authenticated","role":"authenticated","email":"2864460459@qq.com","email_confirmed_at":"2025-09-29T15:42:18.953805Z","phone":"","confirmed_at":"2025-09-29T15:42:18.953805Z","last_sign_in_at":"2025-09-29T15:42:21.761683Z","app_metadata":{"provider":"github","providers":["github"]},"user_metadata":{"avatar_url":"https://avatars.githubusercontent.com/u/128880206?v=4","email":"2864460459@qq.com","email_verified":true,"full_name":"Chinese-tingfeng","iss":"https://api.github.com","name":"Chinese-tingfeng","phone_verified":false,"preferred_username":"lzA6","provider_id":"128880206","sub":"128880206","user_name":"lzA6"},"identities":[{"identity_id":"f3fd9077-2a8c-422d-b607-0a721f4ab6c2","id":"128880206","user_id":"5905f6b4-d74f-46b4-9b4f-9dbbccb29bee","identity_data":{"avatar_url":"https://avatars.githubusercontent.com/u/128880206?v=4","email":"2864460459@qq.com","email_verified":true,"full_name":"Chinese-tingfeng","iss":"https://api.github.com","name":"Chinese-tingfeng","phone_verified":false,"preferred_username":"lzA6","provider_id":"128880206","sub":"128880206","user_name":"lzA6"},"provider":"github","last_sign_in_at":"2025-09-29T15:42:18.9472Z","created_at":"2025-09-29T15:42:18.947275Z","updated_at":"2025-09-29T15:42:18.947275Z","email":"2864460459@qq.com"}],"created_at":"2025-09-29T15:42:18.943571Z","updated_at":"2025-10-18T11:41:04.939715Z","is_anonymous":false}}'

# --- ä¼šè¯ç®¡ç† ---
# å¯¹è¯å†å²åœ¨å†…å­˜ä¸­çš„ç¼“å­˜æ—¶é—´ï¼ˆç§’ï¼‰ï¼Œé»˜è®¤1å°æ—¶
SESSION_CACHE_TTL=3600


--- æ–‡ä»¶è·¯å¾„: .env.example ---

# ====================================================================
# smithery-2api é…ç½®æ–‡ä»¶æ¨¡æ¿
# ====================================================================
#
# è¯·å°†æ­¤æ–‡ä»¶é‡å‘½åä¸º ".env" å¹¶å¡«å…¥æ‚¨çš„å‡­è¯ã€‚
#

# --- æ ¸å¿ƒå®‰å…¨é…ç½® (å¿…é¡»è®¾ç½®) ---
# ç”¨äºä¿æŠ¤æ‚¨ API æœåŠ¡çš„è®¿é—®å¯†é’¥ã€‚
API_MASTER_KEY=sk-smithery-2api-default-key-please-change-me

# --- éƒ¨ç½²é…ç½® (å¯é€‰) ---
# Nginx å¯¹å¤–æš´éœ²çš„ç«¯å£
NGINX_PORT=8088

# --- Smithery.ai å‡­è¯ (å¿…é¡»è®¾ç½®) ---
# è¯·ä»æµè§ˆå™¨å¼€å‘è€…å·¥å…·ä¸­è·å–å®Œæ•´çš„ Cookie å­—ç¬¦ä¸²ã€‚
# æ”¯æŒå¤šè´¦å·è½®è¯¢ï¼Œåªéœ€æŒ‰æ ¼å¼æ·»åŠ  SMITHERY_COOKIE_2, SMITHERY_COOKIE_3, ...
SMITHERY_COOKIE_1="åœ¨æ­¤å¤„ç²˜è´´æ‚¨çš„å®Œæ•´ Cookie å­—ç¬¦ä¸²"

# --- ä¼šè¯ç®¡ç† (å¯é€‰) ---
# å¯¹è¯å†å²åœ¨å†…å­˜ä¸­çš„ç¼“å­˜æ—¶é—´ï¼ˆç§’ï¼‰ï¼Œé»˜è®¤1å°æ—¶
SESSION_CACHE_TTL=3600


--- æ–‡ä»¶è·¯å¾„: Dockerfile ---

# ====================================================================
# Dockerfile for smithery-2api (v1.0 - Genesis Omega Edition)
# ====================================================================

FROM python:3.10-slim

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1
WORKDIR /app

# å®‰è£… Python ä¾èµ–
COPY requirements.txt .
RUN pip install --no-cache-dir --upgrade pip && \
    pip install --no-cache-dir -r requirements.txt

# å¤åˆ¶åº”ç”¨ä»£ç 
COPY . .

# åˆ›å»ºå¹¶åˆ‡æ¢åˆ°é root ç”¨æˆ·
RUN useradd --create-home appuser && \
    chown -R appuser:appuser /app
USER appuser

# æš´éœ²ç«¯å£å¹¶å¯åŠ¨
EXPOSE 8000
CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000", "--workers", "1"]


--- æ–‡ä»¶è·¯å¾„: docker-compose.yml ---

services:
  nginx:
    image: nginx:latest
    container_name: smithery-2api-nginx
    restart: always
    ports:
      - "${NGINX_PORT:-8088}:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - app
    networks:
      - smithery-net

  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: smithery-2api-app
    restart: unless-stopped
    env_file:
      - .env
    networks:
      - smithery-net

networks:
  smithery-net:
    driver: bridge


--- æ–‡ä»¶è·¯å¾„: main.py ---

import logging
from contextlib import asynccontextmanager
from typing import Optional

from fastapi import FastAPI, Request, HTTPException, Depends, Header
from fastapi.responses import JSONResponse, StreamingResponse

from app.core.config import settings
from app.providers.smithery_provider import SmitheryProvider

logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(name)s - %(levelname)s - %(message)s')
logger = logging.getLogger(__name__)

provider = SmitheryProvider()

@asynccontextmanager
async def lifespan(app: FastAPI):
    logger.info(f"åº”ç”¨å¯åŠ¨ä¸­... {settings.APP_NAME} v{settings.APP_VERSION}")
    logger.info("æœåŠ¡å·²è¿›å…¥ 'Cloudscraper' æ¨¡å¼ï¼Œå°†è‡ªåŠ¨å¤„ç† Cloudflare æŒ‘æˆ˜ã€‚")
    logger.info(f"æœåŠ¡å°†åœ¨ http://localhost:{settings.NGINX_PORT} ä¸Šå¯ç”¨")
    yield
    logger.info("åº”ç”¨å…³é—­ã€‚")

app = FastAPI(
    title=settings.APP_NAME,
    version=settings.APP_VERSION,
    description=settings.DESCRIPTION,
    lifespan=lifespan
)

async def verify_api_key(authorization: Optional[str] = Header(None)):
    if settings.API_MASTER_KEY and settings.API_MASTER_KEY != "1":
        if not authorization or "bearer" not in authorization.lower():
            raise HTTPException(status_code=401, detail="éœ€è¦ Bearer Token è®¤è¯ã€‚")
        token = authorization.split(" ")[-1]
        if token != settings.API_MASTER_KEY:
            raise HTTPException(status_code=403, detail="æ— æ•ˆçš„ API Keyã€‚")

@app.post("/v1/chat/completions", dependencies=[Depends(verify_api_key)])
async def chat_completions(request: Request) -> StreamingResponse:
    try:
        request_data = await request.json()
        return await provider.chat_completion(request_data)
    except Exception as e:
        logger.error(f"å¤„ç†èŠå¤©è¯·æ±‚æ—¶å‘ç”Ÿé¡¶å±‚é”™è¯¯: {e}", exc_info=True)
        raise HTTPException(status_code=500, detail=f"å†…éƒ¨æœåŠ¡å™¨é”™è¯¯: {str(e)}")

@app.get("/v1/models", dependencies=[Depends(verify_api_key)], response_class=JSONResponse)
async def list_models():
    return await provider.get_models()

@app.get("/", summary="æ ¹è·¯å¾„")
def root():
    return {"message": f"æ¬¢è¿æ¥åˆ° {settings.APP_NAME} v{settings.APP_VERSION}. æœåŠ¡è¿è¡Œæ­£å¸¸ã€‚"}


--- æ–‡ä»¶è·¯å¾„: nginx.conf ---

worker_processes auto;

events {
    worker_connections 1024;
}

http {
    upstream smithery_backend {
        server app:8000;
    }

    server {
        listen 80;
        server_name localhost;

        location / {
            proxy_pass http://smithery_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            proxy_buffering off;
            proxy_cache off;
            proxy_set_header Connection '';
            proxy_http_version 1.1;
            chunked_transfer_encoding off;
        }
    }
}


--- æ–‡ä»¶è·¯å¾„: requirements.txt ---

fastapi
uvicorn[standard]
pydantic-settings
python-dotenv
cloudscraper
cachetools
httpx


--- æ–‡ä»¶è·¯å¾„: app\core\__init__.py ---



--- æ–‡ä»¶è·¯å¾„: app\core\config.py ---

import os
import json
import logging
from pydantic_settings import BaseSettings, SettingsConfigDict
from typing import List, Optional, Dict

# è·å–ä¸€ä¸ªæ—¥å¿—è®°å½•å™¨å®ä¾‹
logger = logging.getLogger(__name__)

class AuthCookie:
    """
    å¤„ç†å¹¶ç”Ÿæˆ Smithery.ai æ‰€éœ€çš„è®¤è¯ Cookieã€‚
    å®ƒå°† .env æ–‡ä»¶ä¸­çš„ JSON å­—ç¬¦ä¸²è½¬æ¢ä¸ºä¸€ä¸ªæ ‡å‡†çš„ HTTP Cookie å¤´éƒ¨å­—ç¬¦ä¸²ã€‚
    """
    def __init__(self, json_string: str):
        try:
            # 1. è§£æä» .env æ–‡ä»¶è¯»å–çš„ JSON å­—ç¬¦ä¸²
            data = json.loads(json_string)
            self.access_token = data.get("access_token")
            self.refresh_token = data.get("refresh_token")
            self.expires_at = data.get("expires_at", 0)
            
            if not self.access_token:
                raise ValueError("Cookie JSON ä¸­ç¼ºå°‘ 'access_token'")

            # 2. æ„é€ å°†è¦æ”¾å…¥ Cookie header çš„å€¼éƒ¨åˆ† (å®ƒæœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ª JSON)
            #    æ³¨æ„ï¼šè¿™é‡Œæˆ‘ä»¬åªåŒ…å« Supabase auth éœ€è¦çš„æ ¸å¿ƒå­—æ®µ
            cookie_value_data = {
                "access_token": self.access_token,
                "refresh_token": self.refresh_token,
                "token_type": data.get("token_type", "bearer"),
                "expires_in": data.get("expires_in", 3600),
                "expires_at": self.expires_at,
                "user": data.get("user")
            }
            
            # 3. æ„é€ å®Œæ•´çš„ Cookie é”®å€¼å¯¹å­—ç¬¦ä¸²
            #    Smithery.ai ä½¿ç”¨çš„ Supabase project_ref æ˜¯ 'spjawbfpwezjfmicopsl'
            project_ref = "spjawbfpwezjfmicopsl"
            cookie_key = f"sb-{project_ref}-auth-token"
            # å°†å€¼éƒ¨åˆ†è½¬æ¢ä¸ºç´§å‡‘çš„ JSON å­—ç¬¦ä¸²
            cookie_value = json.dumps(cookie_value_data, separators=(',', ':'))
            
            # æœ€ç»ˆç”¨äº HTTP Header çš„å­—ç¬¦ä¸²ï¼Œæ ¼å¼ä¸º "key=value"
            self.header_cookie_string = f"{cookie_key}={cookie_value}"

        except json.JSONDecodeError as e:
            raise ValueError(f"æ— æ³•ä»æä¾›çš„å­—ç¬¦ä¸²ä¸­è§£æè®¤è¯ JSON: {e}")
        except Exception as e:
            raise ValueError(f"åˆå§‹åŒ– AuthCookie æ—¶å‡ºé”™: {e}")

    def __repr__(self):
        return f"<AuthCookie expires_at={self.expires_at}>"


class Settings(BaseSettings):
    model_config = SettingsConfigDict(
        env_file=".env",
        env_file_encoding='utf-8',
        extra="ignore"
    )

    APP_NAME: str = "smithery-2api"
    APP_VERSION: str = "1.0.0"
    DESCRIPTION: str = "ä¸€ä¸ªå°† smithery.ai è½¬æ¢ä¸ºå…¼å®¹ OpenAI æ ¼å¼ API çš„é«˜æ€§èƒ½ä»£ç†ï¼Œæ”¯æŒå¤šè´¦å·ã€ä¸Šä¸‹æ–‡å’Œå·¥å…·è°ƒç”¨ã€‚"

    CHAT_API_URL: str = "https://smithery.ai/api/chat"
    TOKEN_REFRESH_URL: str = "https://spjawbfpwezjfmicopsl.supabase.co/auth/v1/token?grant_type=refresh_token"
    SUPABASE_API_KEY: str = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNwamF3YmZwd2V6amZtaWNvcHNsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzQxNDc0MDUsImV4cCI6MjA0OTcyMzQwNX0.EBIg7_F2FZh4KZ3UNwZdBRjpp2fgHqXGJOvOSQ053MU"

    API_MASTER_KEY: Optional[str] = None
    
    AUTH_COOKIES: List[AuthCookie] = []

    API_REQUEST_TIMEOUT: int = 180
    NGINX_PORT: int = 8088
    SESSION_CACHE_TTL: int = 3600

    KNOWN_MODELS: List[str] = [
        "claude-haiku-4.5", "claude-sonnet-4.5", "gpt-5", "gpt-5-mini", 
        "gpt-5-nano", "gemini-2.5-flash-lite", "gemini-2.5-pro", "glm-4.6", 
        "grok-4-fast-non-reasoning", "grok-4-fast-reasoning", "kimi-k2", "deepseek-reasoner"
    ]

    def __init__(self, **values):
        super().__init__(**values)
        # ä»ç¯å¢ƒå˜é‡ SMITHERY_COOKIE_1, SMITHERY_COOKIE_2, ... åŠ è½½ cookies
        i = 1
        while True:
            cookie_str = os.getenv(f"SMITHERY_COOKIE_{i}")
            if cookie_str:
                try:
                    # ä½¿ç”¨ AuthCookie ç±»æ¥è§£æå’Œå¤„ç† cookie å­—ç¬¦ä¸²
                    self.AUTH_COOKIES.append(AuthCookie(cookie_str))
                except ValueError as e:
                    logger.warning(f"æ— æ³•åŠ è½½æˆ–è§£æ SMITHERY_COOKIE_{i}: {e}")
                i += 1
            else:
                break
        
        if not self.AUTH_COOKIES:
            raise ValueError("å¿…é¡»åœ¨ .env æ–‡ä»¶ä¸­è‡³å°‘é…ç½®ä¸€ä¸ªæœ‰æ•ˆçš„ SMITHERY_COOKIE_1")

settings = Settings()


--- æ–‡ä»¶è·¯å¾„: app\providers\__init__.py ---



--- æ–‡ä»¶è·¯å¾„: app\providers\base_provider.py ---

from abc import ABC, abstractmethod
from typing import Dict, Any
from fastapi.responses import StreamingResponse, JSONResponse

class BaseProvider(ABC):
    @abstractmethod
    async def chat_completion(
        self,
        request_data: Dict[str, Any]
    ) -> StreamingResponse:
        pass

    @abstractmethod
    async def get_models(self) -> JSONResponse:
        pass


--- æ–‡ä»¶è·¯å¾„: app\providers\smithery_provider.py ---

import json
import time
import logging
import uuid
import random
import cloudscraper
from typing import Dict, Any, AsyncGenerator, List

from fastapi import HTTPException
from fastapi.responses import StreamingResponse, JSONResponse

from app.core.config import settings
from app.providers.base_provider import BaseProvider
# ç§»é™¤äº†ä¸å†ä½¿ç”¨çš„ SessionManager
# from app.services.session_manager import SessionManager
from app.utils.sse_utils import create_sse_data, create_chat_completion_chunk, DONE_CHUNK

logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(name)s - [%(levelname)s] - %(message)s')
logger = logging.getLogger(__name__)

class SmitheryProvider(BaseProvider):
    def __init__(self):
        # self.session_manager = SessionManager() # ç§»é™¤ä¼šè¯ç®¡ç†å™¨
        self.scraper = cloudscraper.create_scraper()
        self.cookie_index = 0

    def _get_cookie(self) -> str:
        """ä»é…ç½®ä¸­è½®æ¢è·å–ä¸€ä¸ªæ ¼å¼æ­£ç¡®çš„ Cookie å­—ç¬¦ä¸²ã€‚"""
        auth_cookie_obj = settings.AUTH_COOKIES[self.cookie_index]
        self.cookie_index = (self.cookie_index + 1) % len(settings.AUTH_COOKIES)
        return auth_cookie_obj.header_cookie_string

    def _convert_messages_to_smithery_format(self, openai_messages: List[Dict[str, Any]]) -> List[Dict[str, Any]]:
        """
        å°†å®¢æˆ·ç«¯å‘æ¥çš„ OpenAI æ ¼å¼æ¶ˆæ¯åˆ—è¡¨è½¬æ¢ä¸º Smithery.ai åç«¯æ‰€éœ€çš„æ ¼å¼ã€‚
        ä¾‹å¦‚: {"role": "user", "content": "ä½ å¥½"} -> {"role": "user", "parts": [{"type": "text", "text": "ä½ å¥½"}]}
        """
        smithery_messages = []
        for msg in openai_messages:
            role = msg.get("role")
            content = msg.get("content", "")
            
            # å¿½ç•¥æ ¼å¼ä¸æ­£ç¡®æˆ–å†…å®¹ä¸ºç©ºçš„æ¶ˆæ¯
            if not role or not isinstance(content, str):
                continue
                
            smithery_messages.append({
                "role": role,
                "parts": [{"type": "text", "text": content}],
                "id": f"msg-{uuid.uuid4().hex[:16]}"
            })
        return smithery_messages

    async def chat_completion(self, request_data: Dict[str, Any]) -> StreamingResponse:
        """
        å¤„ç†èŠå¤©è¡¥å…¨è¯·æ±‚ã€‚
        æ­¤å®ç°ä¸ºæ— çŠ¶æ€æ¨¡å¼ï¼Œå®Œå…¨ä¾èµ–å®¢æˆ·ç«¯å‘é€çš„å®Œæ•´å¯¹è¯å†å²ã€‚
        """
        
        # 1. ç›´æ¥ä»å®¢æˆ·ç«¯è¯·æ±‚ä¸­è·å–å®Œæ•´çš„æ¶ˆæ¯å†å²
        messages_from_client = request_data.get("messages", [])
        
        # 2. å°†å…¶è½¬æ¢ä¸º Smithery.ai åç«¯æ‰€éœ€çš„æ ¼å¼
        smithery_formatted_messages = self._convert_messages_to_smithery_format(messages_from_client)

        async def stream_generator() -> AsyncGenerator[bytes, None]:
            request_id = f"chatcmpl-{uuid.uuid4()}"
            model = request_data.get("model", "claude-haiku-4.5")
            
            try:
                # 3. ä½¿ç”¨è½¬æ¢åçš„æ¶ˆæ¯åˆ—è¡¨å‡†å¤‡è¯·æ±‚ä½“
                payload = self._prepare_payload(model, smithery_formatted_messages)
                headers = self._prepare_headers()
                
                logger.info("===================== [REQUEST TO SMITHERY (Stateless)] =====================")
                logger.info(f"URL: POST {settings.CHAT_API_URL}")
                logger.info(f"PAYLOAD:\n{json.dumps(payload, indent=2, ensure_ascii=False)}")
                logger.info("=====================================================================================")

                # ä½¿ç”¨ cloudscraper å‘é€è¯·æ±‚
                response = self.scraper.post(
                    settings.CHAT_API_URL, 
                    headers=headers, 
                    json=payload, 
                    stream=True, 
                    timeout=settings.API_REQUEST_TIMEOUT
                )

                if response.status_code != 200:
                    logger.error("==================== [RESPONSE FROM SMITHERY (ERROR)] ===================")
                    logger.error(f"STATUS CODE: {response.status_code}")
                    logger.error(f"RESPONSE BODY:\n{response.text}")
                    logger.error("=================================================================")
                
                response.raise_for_status()

                # 4. æµå¼å¤„ç†è¿”å›çš„æ•°æ® (æ­¤éƒ¨åˆ†é€»è¾‘ä¸å˜)
                for line in response.iter_lines():
                    if line.startswith(b"data:"):
                        content = line[len(b"data:"):].strip()
                        if content == b"[DONE]":
                            break
                        try:
                            data = json.loads(content)
                            if data.get("type") == "text-delta":
                                delta_content = data.get("delta", "")
                                chunk = create_chat_completion_chunk(request_id, model, delta_content)
                                yield create_sse_data(chunk)
                        except json.JSONDecodeError:
                            if content:
                                logger.warning(f"æ— æ³•è§£æ SSE æ•°æ®å—: {content}")
                            continue
                
                # 5. æ— çŠ¶æ€æ¨¡å¼ä¸‹ï¼Œæ— éœ€ä¿å­˜ä»»ä½•ä¼šè¯ï¼Œç›´æ¥å‘é€ç»“æŸæ ‡å¿—
                final_chunk = create_chat_completion_chunk(request_id, model, "", "stop")
                yield create_sse_data(final_chunk)
                yield DONE_CHUNK

            except Exception as e:
                logger.error(f"å¤„ç†æµæ—¶å‘ç”Ÿé”™è¯¯: {e}", exc_info=True)
                error_message = f"å†…éƒ¨æœåŠ¡å™¨é”™è¯¯: {str(e)}"
                error_chunk = create_chat_completion_chunk(request_id, model, error_message, "stop")
                yield create_sse_data(error_chunk)
                yield DONE_CHUNK

        return StreamingResponse(stream_generator(), media_type="text/event-stream")

    def _prepare_headers(self) -> Dict[str, str]:
        # åŒ…å«æˆ‘ä»¬ä¹‹å‰åˆ†æå‡ºçš„æ‰€æœ‰å¿…è¦è¯·æ±‚å¤´
        return {
            "Accept": "*/*",
            "Accept-Language": "zh-CN,zh;q=0.9,en;q=0.8",
            "Content-Type": "application/json",
            "Cookie": self._get_cookie(),
            "Origin": "https://smithery.ai",
            "Referer": "https://smithery.ai/playground",
            "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36",
            "priority": "u=1, i",
            "sec-ch-ua": '"Not_A Brand";v="8", "Chromium";v="120", "Google Chrome";v="120"',
            "sec-ch-ua-mobile": "?0",
            "sec-ch-ua-platform": '"Windows"',
            "sec-fetch-dest": "empty",
            "sec-fetch-mode": "cors",
            "sec-fetch-site": "same-origin",
            "x-posthog-distinct-id": "5905f6b4-d74f-46b4-9b4f-9dbbccb29bee",
            "x-posthog-session-id": "0199f71f-8c42-7f9a-ba3a-ff5999dd444a",
            "x-posthog-window-id": "0199f71f-8c42-7f9a-ba3a-ff5ab5b20a8e",
        }

    def _prepare_payload(self, model: str, messages: List[Dict[str, Any]]) -> Dict[str, Any]:
        return {
            "messages": messages,
            "tools": [],
            "model": model,
            "systemPrompt": "You are a helpful assistant."
        }

    async def get_models(self) -> JSONResponse:
        model_data = {
            "object": "list",
            "data": [
                {"id": name, "object": "model", "created": int(time.time()), "owned_by": "lzA6"}
                for name in settings.KNOWN_MODELS
            ]
        }
        return JSONResponse(content=model_data)


--- æ–‡ä»¶è·¯å¾„: app\services\session_manager.py ---

from cachetools import TTLCache
from typing import List, Dict, Any
from app.core.config import settings

class SessionManager:
    def __init__(self):
        self.cache = TTLCache(maxsize=1024, ttl=settings.SESSION_CACHE_TTL)

    def get_messages(self, session_id: str) -> List[Dict[str, Any]]:
        """
        ä»ç¼“å­˜ä¸­è·å–æ¶ˆæ¯å†å²ã€‚
        è¿”å›åˆ—è¡¨çš„å‰¯æœ¬ä»¥é˜²æ­¢å¯¹ç¼“å­˜çš„æ„å¤–ä¿®æ”¹ã€‚
        """
        return self.cache.get(session_id, []).copy()

    def update_messages(self, session_id: str, messages: List[Dict[str, Any]]):
        """
        å°†æ›´æ–°åçš„æ¶ˆæ¯å†å²å­˜å›ç¼“å­˜ã€‚
        """
        self.cache[session_id] = messages


--- æ–‡ä»¶è·¯å¾„: app\services\tool_caller.py ---

import json
import logging
import random
from typing import List, Dict, Any
import cloudscraper

logger = logging.getLogger(__name__)

class ToolCaller:
    def __init__(self):
        self.mcp_url = "https://mcp.exa.ai/mcp"
        self.mcp_params = {
            "profile": "joyous-gull-NeZ2gW",
            "api_key": "fe5676be-931d-42e1-b5c9-90e94dce45ae"
        }
        self.scraper = cloudscraper.create_scraper()

    def get_tool_definitions(self) -> List[Dict[str, Any]]:
        # ä»æƒ…æŠ¥ä¸­æå–çš„å·¥å…·å®šä¹‰
        return [
            {"name":"resolve-library-id","title":"Resolve Context7 Library ID","description":"...","inputSchema":{}},
            {"name":"get-library-docs","title":"Get Library Docs","description":"...","inputSchema":{}},
            {"name":"web_search_exa","description":"...","inputSchema":{}},
            {"name":"get_code_context_exa","description":"...","inputSchema":{}}
        ]

    async def execute_tools(self, tool_calls: List[Dict[str, Any]]) -> List[Dict[str, Any]]:
        # æ­¤å‡½æ•°ç°åœ¨è¿”å›ä¸€ä¸ªå•ä¸€çš„ç”¨æˆ·æ¶ˆæ¯ï¼Œå…¶ä¸­åŒ…å«æ‰€æœ‰å·¥å…·çš„ç»“æœ
        all_results_content = "Tool results:\n"
        
        for call in tool_calls:
            function_call = call.get("function", {})
            tool_name = function_call.get("name")
            tool_args_str = function_call.get("arguments", "{}")
            tool_call_id = call.get("id")

            logger.info(f"æ‰§è¡Œå·¥å…·è°ƒç”¨: {tool_name} with args {tool_args_str}")
            
            try:
                arguments = json.loads(tool_args_str)
                payload = {
                    "method": "tools/call",
                    "params": {"name": tool_name, "arguments": arguments},
                    "jsonrpc": "2.0",
                    "id": random.randint(1, 100)
                }
                
                response = self.scraper.post(self.mcp_url, params=self.mcp_params, json=payload)
                response.raise_for_status()
                
                result_content = "No content returned."
                for line in response.iter_lines():
                    if line.startswith(b"data:"):
                        content_str = line[len(b"data:"):].strip().decode('utf-8', errors='ignore')
                        if content_str == "[DONE]":
                            break
                        try:
                            data = json.loads(content_str)
                            if "result" in data and "content" in data["result"]:
                                # å°†ç»“æœæ ¼å¼åŒ–ä¸ºæ›´æ˜“è¯»çš„å­—ç¬¦ä¸²
                                result_content = json.dumps(data["result"]["content"], ensure_ascii=False, indent=2)
                                break
                        except json.JSONDecodeError:
                            logger.warning(f"MCP tool: æ— æ³•è§£æ SSE æ•°æ®å—: {content_str}")
                            continue
                
                all_results_content += f"\n--- Result for {tool_name} (call_id: {tool_call_id}) ---\n{result_content}\n"

            except Exception as e:
                logger.error(f"å·¥å…·è°ƒç”¨å¤±è´¥: {e}", exc_info=True)
                error_str = f'{{"error": "Tool call failed", "details": "{str(e)}"}}'
                all_results_content += f"\n--- Error for {tool_name} (call_id: {tool_call_id}) ---\n{error_str}\n"

        # è¿”å›ä¸€ä¸ªå•ä¸€çš„ç”¨æˆ·æ¶ˆæ¯ï¼Œè€Œä¸æ˜¯å¤šä¸ª tool è§’è‰²çš„æ¶ˆæ¯
        return [{"role": "user", "content": all_results_content}]


--- æ–‡ä»¶è·¯å¾„: app\utils\sse_utils.py ---

import json
import time
from typing import Dict, Any, Optional

DONE_CHUNK = b"data: [DONE]\n\n"

def create_sse_data(data: Dict[str, Any]) -> bytes:
    return f"data: {json.dumps(data)}\n\n".encode('utf-8')

def create_chat_completion_chunk(
    request_id: str,
    model: str,
    content: str,
    finish_reason: Optional[str] = None
) -> Dict[str, Any]:
    return {
        "id": request_id,
        "object": "chat.completion.chunk",
        "created": int(time.time()),
        "model": model,
        "choices": [
            {
                "index": 0,
                "delta": {"content": content},
                "finish_reason": finish_reason
            }
        ]
    }



